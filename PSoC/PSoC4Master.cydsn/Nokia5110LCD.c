/*!
 *  @file       Nokia5110LCD.c
 *  @brief      Nokia5110LCD Modul (Impoteret)
 *  @details    Impoteret kildekode til Nokia 5110 LSD
 *  @author     Matt (cy.wbz)
 *  @remark     https://www.element14.com/community/thread/26122/l/psoc-4-pioneer-kit-community-project061-nokia-5110-lcd-interface?displayFullThread=true
 */
#include "Nokia5110LCD.h"

/* Width = 5 * Height = 8 for one character */
/* excluding one vertical space before and after the character */
/* for the ASCII values from 20 as the values <20 are escape characters */

static const uint8 Fonts[][FONT_WIDTH] = {
  {0x00, 0x00, 0x00, 0x00, 0x00}  // 20  
  ,{0x00, 0x00, 0x5f, 0x00, 0x00} // 21 !
  ,{0x00, 0x07, 0x00, 0x07, 0x00} // 22 "
  ,{0x14, 0x7f, 0x14, 0x7f, 0x14} // 23 #
  ,{0x24, 0x2a, 0x7f, 0x2a, 0x12} // 24 $
  ,{0x23, 0x13, 0x08, 0x64, 0x62} // 25 %
  ,{0x36, 0x49, 0x55, 0x22, 0x50} // 26 &
  ,{0x00, 0x05, 0x03, 0x00, 0x00} // 27 '
  ,{0x00, 0x1c, 0x22, 0x41, 0x00} // 28 (
  ,{0x00, 0x41, 0x22, 0x1c, 0x00} // 29 )
  ,{0x14, 0x08, 0x3e, 0x08, 0x14} // 2a *
  ,{0x08, 0x08, 0x3e, 0x08, 0x08} // 2b +
  ,{0x00, 0x50, 0x30, 0x00, 0x00} // 2c ,
  ,{0x08, 0x08, 0x08, 0x08, 0x08} // 2d -
  ,{0x00, 0x60, 0x60, 0x00, 0x00} // 2e .
  ,{0x20, 0x10, 0x08, 0x04, 0x02} // 2f /
  ,{0x3e, 0x51, 0x49, 0x45, 0x3e} // 30 0
  ,{0x00, 0x42, 0x7f, 0x40, 0x00} // 31 1
  ,{0x42, 0x61, 0x51, 0x49, 0x46} // 32 2
  ,{0x21, 0x41, 0x45, 0x4b, 0x31} // 33 3
  ,{0x18, 0x14, 0x12, 0x7f, 0x10} // 34 4
  ,{0x27, 0x45, 0x45, 0x45, 0x39} // 35 5
  ,{0x3c, 0x4a, 0x49, 0x49, 0x30} // 36 6
  ,{0x01, 0x71, 0x09, 0x05, 0x03} // 37 7
  ,{0x36, 0x49, 0x49, 0x49, 0x36} // 38 8
  ,{0x06, 0x49, 0x49, 0x29, 0x1e} // 39 9
  ,{0x00, 0x36, 0x36, 0x00, 0x00} // 3a :
  ,{0x00, 0x56, 0x36, 0x00, 0x00} // 3b ;
  ,{0x08, 0x14, 0x22, 0x41, 0x00} // 3c <
  ,{0x14, 0x14, 0x14, 0x14, 0x14} // 3d =
  ,{0x00, 0x41, 0x22, 0x14, 0x08} // 3e >
  ,{0x02, 0x01, 0x51, 0x09, 0x06} // 3f ?
  ,{0x32, 0x49, 0x79, 0x41, 0x3e} // 40 @
  ,{0x7e, 0x11, 0x11, 0x11, 0x7e} // 41 A
  ,{0x7f, 0x49, 0x49, 0x49, 0x36} // 42 B
  ,{0x3e, 0x41, 0x41, 0x41, 0x22} // 43 C
  ,{0x7f, 0x41, 0x41, 0x22, 0x1c} // 44 D
  ,{0x7f, 0x49, 0x49, 0x49, 0x41} // 45 E
  ,{0x7f, 0x09, 0x09, 0x09, 0x01} // 46 F
  ,{0x3e, 0x41, 0x49, 0x49, 0x7a} // 47 G
  ,{0x7f, 0x08, 0x08, 0x08, 0x7f} // 48 H
  ,{0x00, 0x41, 0x7f, 0x41, 0x00} // 49 I
  ,{0x20, 0x40, 0x41, 0x3f, 0x01} // 4a J
  ,{0x7f, 0x08, 0x14, 0x22, 0x41} // 4b K
  ,{0x7f, 0x40, 0x40, 0x40, 0x40} // 4c L
  ,{0x7f, 0x02, 0x0c, 0x02, 0x7f} // 4d M
  ,{0x7f, 0x04, 0x08, 0x10, 0x7f} // 4e N
  ,{0x3e, 0x41, 0x41, 0x41, 0x3e} // 4f O
  ,{0x7f, 0x09, 0x09, 0x09, 0x06} // 50 P
  ,{0x3e, 0x41, 0x51, 0x21, 0x5e} // 51 Q
  ,{0x7f, 0x09, 0x19, 0x29, 0x46} // 52 R
  ,{0x46, 0x49, 0x49, 0x49, 0x31} // 53 S
  ,{0x01, 0x01, 0x7f, 0x01, 0x01} // 54 T
  ,{0x3f, 0x40, 0x40, 0x40, 0x3f} // 55 U
  ,{0x1f, 0x20, 0x40, 0x20, 0x1f} // 56 V
  ,{0x3f, 0x40, 0x38, 0x40, 0x3f} // 57 W
  ,{0x63, 0x14, 0x08, 0x14, 0x63} // 58 X
  ,{0x07, 0x08, 0x70, 0x08, 0x07} // 59 Y
  ,{0x61, 0x51, 0x49, 0x45, 0x43} // 5a Z
  ,{0x00, 0x7f, 0x41, 0x41, 0x00} // 5b [
  ,{0x02, 0x04, 0x08, 0x10, 0x20} // 5c /
  ,{0x00, 0x41, 0x41, 0x7f, 0x00} // 5d ]
  ,{0x04, 0x02, 0x01, 0x02, 0x04} // 5e ^
  ,{0x40, 0x40, 0x40, 0x40, 0x40} // 5f _
  ,{0x00, 0x01, 0x02, 0x04, 0x00} // 60 `
  ,{0x20, 0x54, 0x54, 0x54, 0x78} // 61 a
  ,{0x7f, 0x48, 0x44, 0x44, 0x38} // 62 b
  ,{0x38, 0x44, 0x44, 0x44, 0x20} // 63 c
  ,{0x38, 0x44, 0x44, 0x48, 0x7f} // 64 d
  ,{0x38, 0x54, 0x54, 0x54, 0x18} // 65 e
  ,{0x08, 0x7e, 0x09, 0x01, 0x02} // 66 f
  ,{0x0c, 0x52, 0x52, 0x52, 0x3e} // 67 g
  ,{0x7f, 0x08, 0x04, 0x04, 0x78} // 68 h
  ,{0x00, 0x44, 0x7d, 0x40, 0x00} // 69 i
  ,{0x20, 0x40, 0x44, 0x3d, 0x00} // 6a j 
  ,{0x7f, 0x10, 0x28, 0x44, 0x00} // 6b k
  ,{0x00, 0x41, 0x7f, 0x40, 0x00} // 6c l
  ,{0x7c, 0x04, 0x18, 0x04, 0x78} // 6d m
  ,{0x7c, 0x08, 0x04, 0x04, 0x78} // 6e n
  ,{0x38, 0x44, 0x44, 0x44, 0x38} // 6f o
  ,{0x7c, 0x14, 0x14, 0x14, 0x08} // 70 p
  ,{0x08, 0x14, 0x14, 0x18, 0x7c} // 71 q
  ,{0x7c, 0x08, 0x04, 0x04, 0x08} // 72 r
  ,{0x48, 0x54, 0x54, 0x54, 0x20} // 73 s
  ,{0x04, 0x3f, 0x44, 0x40, 0x20} // 74 t
  ,{0x3c, 0x40, 0x40, 0x20, 0x7c} // 75 u
  ,{0x1c, 0x20, 0x40, 0x20, 0x1c} // 76 v
  ,{0x3c, 0x40, 0x30, 0x40, 0x3c} // 77 w
  ,{0x44, 0x28, 0x10, 0x28, 0x44} // 78 x
  ,{0x0c, 0x50, 0x50, 0x50, 0x3c} // 79 y
  ,{0x44, 0x64, 0x54, 0x4c, 0x44} // 7a z
  ,{0x00, 0x08, 0x36, 0x41, 0x00} // 7b {
  ,{0x00, 0x00, 0x7f, 0x00, 0x00} // 7c |
  ,{0x00, 0x41, 0x36, 0x08, 0x00} // 7d }
  ,{0x10, 0x08, 0x08, 0x10, 0x08} // 7e ~
  ,{0x78, 0x46, 0x41, 0x46, 0x78} // 7f DEL
};

//Cypress Logo in bitmap form using http://pixlr.com/editor/

static const char CypressLogo[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xA0, 0xB0, 0xB0, 0xB8, 0xB8, 0xBC, 0xBC, 0xFC, 0xFC,
0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xF0, 0xF0, 0xE0, 0x80,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF6, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xFF,
0x9F, 0x9F, 0x8F, 0x8F, 0x07, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x07, 0x07, 0x07, 0x06, 0x04, 0x04, 0x04, 0x04, 0x0C, 0x1C, 0x10, 0xD0, 0xF0, 0x70,
0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7B, 0x7B, 0x7B, 0x7B, 0x7B, 0x7B,
0x7B, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFC, 0xFC, 0xFC, 0xFE, 0xFE, 0xFE,
0xFE, 0xFE, 0xFE, 0xD8, 0x18, 0x00, 0x00, 0xD0, 0x70, 0xF8, 0xF0, 0xF8, 0x1C, 0x1E, 0x1E, 0x1E,
0x1A, 0x15, 0x1F, 0x14, 0x1C, 0x0C, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0F,
0x3F, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xBF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x1F, 0xCF, 0xF0, 0xF8, 0xFF, 0xFF, 0xFF, 0x3F, 0x0F, 0x00,
0x00, 0x00, 0xF8, 0x06, 0x03, 0x01, 0x01, 0x01, 0x03, 0x06, 0x01, 0x07, 0x39, 0xF8, 0x0F, 0x01,
0x00, 0xFF, 0x61, 0x61, 0x61, 0x23, 0x1C, 0xFF, 0x21, 0x21, 0x21, 0xF3, 0x0C, 0x01, 0xFF, 0x21,
0x21, 0x71, 0x03, 0x00, 0x1F, 0x31, 0x21, 0x23, 0xC7, 0x00, 0x1F, 0x31, 0x21, 0x63, 0xC7, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x07, 0x07, 0x07, 0x17, 0x17, 0x37, 0x37, 0x37, 0x37,
0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x07, 0x00, 0x30, 0x1C, 0x0F, 0x0F, 0x07, 0x03, 0x01,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x23, 0x26, 0x24, 0x24, 0x24, 0x26, 0x20, 0x20, 0x20,
0x24, 0x27, 0x20, 0x20, 0x20, 0x27, 0x24, 0x20, 0x20, 0x20, 0x20, 0x27, 0x24, 0x20, 0x20, 0x27,
0x24, 0x24, 0x27, 0x24, 0x24, 0x24, 0x27, 0x27, 0x26, 0x24, 0x24, 0x24, 0x23, 0x27, 0x26, 0x24,
0x24, 0x26, 0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1F, 0x05, 0x00, 0x00, 0x00, 0x1F, 0x15, 0x00, 0x00, 0x00, 0x0F, 0x1F,
0x00, 0x00, 0x00, 0x0F, 0x05, 0x00, 0x00, 0x00, 0x1A, 0x11, 0x09, 0x06, 0x00, 0x00, 0x1F, 0x0D,
0x02, 0x00, 0x00, 0x1C, 0x0F, 0x0C, 0x1F, 0x00, 
};

/*******************************************************************************
* Function Name: LCD_Character
********************************************************************************
*
* Summary:
*  Set the data mode and map the character to the corresponding data based on 
*  ASCII value and send it to LCD. Before & after a character (width of 5 segments)
*  insert a space character (width of 1 segment each) for clarity
*
* Parameters:  
*  uint8 character - Send the character to be displayed
*
* Return: 
*  None 
*  
*******************************************************************************/

void LCD_Character(uint8 character)
{
	uint16 index1;
	LCD_Write(LCD_DATA, EMPTY_COLUMN_DATA);

	for (index1 = 0 ; index1 < FONT_WIDTH ; index1++)
        LCD_Write(LCD_DATA, Fonts[character - OFFSET_FOR_ASCII][index1]);

    LCD_Write(LCD_DATA, EMPTY_COLUMN_DATA);
}

/*******************************************************************************
* Function Name: LCD_Clear
********************************************************************************
*
* Summary:
*  Write 0 to all the segments of LCD from 0,0 to 84,48
*
* Parameters:  
*  None 
*
* Return: 
*  None 
*  
*******************************************************************************/

void LCD_Clear(void)
{
    uint16 index2;
    LCD_gotoXY(COLUMN_BEGINNING, ROW_BEGINNING);
    
	for (index2 = 0 ; index2 < (LCD_X * LCD_Y/FONT_HEIGHT) ; index2++)
    	LCD_Write(LCD_DATA, EMPTY_COLUMN_DATA);
        
  	LCD_gotoXY(COLUMN_BEGINNING, ROW_BEGINNING);
}

/*******************************************************************************
* Function Name: LCD_Init
********************************************************************************
*
* Summary:
*  Enable power to LCD's Vcc & BL pins and also send the initialization sequence
*  to the LCD. At the end, display Cypress Logo and wait for 1 second 
*
* Parameters:  
*  None 
*
* Return: 
*  None 
*  
*******************************************************************************/

void LCD_Init(void)
{
    /* Enable Gnd, Vcc & Backlight pins */
    Gnd_Write(LOW);
    Vcc_Write(HIGH);
    BL_Write(HIGH);
    
    /* Reset the LCD - Active Low (1 -> 0 -> 1) */
    RST_Write(HIGH);
    CyDelay(DELAY_1_MS);
    RST_Write(LOW);
    CyDelay(DELAY_1_MS);
    RST_Write(HIGH);
    CyDelay(DELAY_1_MS);
    
    /* No Power Down, Horizontal Addressing Mode, Extended Instruction set */
    /* 0x21 = 0010 0001    Instruction : Function Set (H=1)*/
    LCD_Write(LCD_COMMAND, CMD_FUNCTION_SET | ((((PD_CHIP_ACTIVE << PD_SHIFT) & PD_MASK) \
    | ((V_HORIZONTAL_ADD << V_SHIFT) & V_MASK) | ((H_EXTENDED_INST << H_SHIFT) & H_MASK)) \
    & FUNCTION_SET_MASK));
        
    /* Set LCD Vop (Contrast): Try 0xB1(good @ 3.3V) or 0xBF if your display is too dark */
    /* 0xB1 = 1100 0000    Instruction : Set Vop */
    LCD_Write(LCD_COMMAND, CMD_SET_VOP | (SET_VOP_5V & SET_VOP_MASK));
  	
    /* Set Temp coefficent */
    /* 0x04 = 0000 0100    Instruction : Temperature Control */
    LCD_Write(LCD_COMMAND, CMD_TEMP_CONTROL | (TEMP_CONTROL_COEFF0 & TEMP_CONTROL_MASK));
  	
    /* LCD bias mode 1:48: Try 0x13 or 0x14 */
    /* 0x13 = 0001 0100    Instruction : Bias System */
    LCD_Write(LCD_COMMAND, CMD_BIAS_SYSTEM | (BIAS_1_BY_8 & BIAS_SYSTEM_MASK));
    
    /* We must send 0x20 before modifying the display control mode */
    /* 0x20 = 0010 0000    Instruction : Function set (H=0)*/
    LCD_Write(LCD_COMMAND, CMD_FUNCTION_SET | ((PD_CHIP_ACTIVE << (PD_SHIFT - 1)) & FUNCTION_SET_MASK));
    
    /* Set display control, normal mode. 0x0D for inverse */
    /* 0x0C = 0000 1101    Instruction : Display control */
    LCD_Write(LCD_COMMAND, CMD_DISPLAY_CONTROL | (DISPLAY_NORMAL & DISPLAY_CONTROL_MASK));
    
    /* Clear the LCD screen */
    LCD_Clear();
    
    /* Display bitmap image of Cypress Logo on the LCD */
//    LCD_Bitmap(CypressLogo);
    
    /* Wait for 1 second before clearing the display */
//    CyDelay(1000);
    
    LCD_Clear();
}

/*******************************************************************************
* Function Name: LCD_String
********************************************************************************
*
* Summary:
*  Send all the characters of a string to LCD one after the other till null character
*
* Parameters:  
*  char *characters - Pointer to a string 
*
* Return: 
*  None 
*  
*******************************************************************************/

void LCD_String(char *characters)
{
	while (*characters)
        LCD_Character(*characters++);
}

/*******************************************************************************
* Function Name: LCD_Write
********************************************************************************
*
* Summary:
*  Mark the value as Data or Command (DC pin) and send it to LCD.
*  Chip enable (CE) pin has to be driven LOW before sending the new data
*
* Parameters:  
*  uint8 data_or_command    - 1 represents Data and 0 represents Command
*  uint8 data_value         - 8 bit value to be sent to the LCD
*
* Return: 
*  None 
*  
*******************************************************************************/

void LCD_Write(uint8 data_or_command, uint8 data_value)
{
    CE_Write(LOW);
    CyDelayUs(DELAY_1_US);
    DC_Write(data_or_command);
    Send_Data(data_value);
    CE_Write(HIGH);
    CyDelayUs(DELAY_1_US);
}

/*******************************************************************************
* Function Name: Send_Data
********************************************************************************
*
* Summary:
*  Low level API to send the data in bit-banging method (bit-by-bit using CPU)
*
* Parameters:  
*  int8 value   -   8-bit Value to be sent
*
* Return: 
*  None 
*  
*******************************************************************************/

void Send_Data(int8 value)
{
    uint8 index3;
    for (index3 = 0; index3 < FONT_HEIGHT; index3++)
    {
        /* Take one bit (MSb) at a time and send it to Data Input pin of LCD */
        if(MSb_POSITION == (value & MSb_POSITION))
            Din_Write(HIGH);
        else
            Din_Write(LOW);
        
        /* After setting the Data value on Din pin, toggle the Clock so that LCD can read Din */
        Clk_Write(HIGH);
        CyDelayUs(DELAY_1_US);
        Clk_Write(LOW);
        CyDelayUs(DELAY_1_US);
        
        /* Left shift the value before processing next bit */
        value <<= SHIFT_LEFT_BY_1;
    }
}

/*******************************************************************************
* Function Name: LCD_gotoXY
********************************************************************************
*
* Summary:
*  Set the cursor to the position defined by x & y parameters
*
* Parameters:  
*  uint8 x  - Column data (Accepted values are from 0 to 83)    -   84 segments
*  uint8 y  - Row data (Accepted values are from 0 to 5)        -   48 segments
*  Each byte value of y correspond to 8 segments of LCD
*
* Return: 
*  None 
*  
*******************************************************************************/

void LCD_gotoXY(uint8 x, uint8 y)
{
    LCD_Write(LCD_COMMAND, CMD_COLUMN_DATA  | (x & COLUMN_DATA_MASK));                       // Column
    LCD_Write(LCD_COMMAND, CMD_ROW_DATA     | (y & ROW_DATA_MASK));     // Row : Last 3 bits are valid
}

/*******************************************************************************
* Function Name: LCD_Bitmap
********************************************************************************
*
* Summary:
*  Thia takes a large array of data corresponding to all segments and sends them to the LCD
*
* Parameters:  
*  char *my_array  -   Character pointer to point to the Bitmap image array
*
* Return: 
*  None 
*  
*******************************************************************************/

void LCD_Bitmap(char *my_array)
{
    uint16 index4;
    for (index4 = 0 ; index4 < (LCD_X * LCD_Y/FONT_HEIGHT) ; index4++)
        
        /* Take one byte at a time and send it to LCD as DATA */
        LCD_Write(LCD_DATA, my_array[index4]);
}

/* [] END OF FILE */
